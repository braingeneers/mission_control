# Global auth settings
set $auth_redirect 0;
set $original_url "https://$host:8443$request_uri";

# Check if the host is not the auth subdomain
if ($host != auth.braingeneers.gi.ucsc.edu) {
    set $auth_check A;
}

# Check if the oauth2_proxy cookie is not set
if ($cookie_oauth2_proxy = "") {
    set $auth_check "${auth_check}B";
}

# Redirect to auth only if both conditions are met
if ($auth_check = AB) {
    return 302 $scheme://auth.braingeneers.gi.ucsc.edu:8443/oauth2/start?rd=$original_url;
}

# If the user is authenticated (oauth2_proxy cookie is set), allow access
if ($cookie_oauth2_proxy != "") {
    set $auth_request_uri "";
}