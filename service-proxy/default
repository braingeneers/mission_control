# Global auth settings
set $auth_redirect 0;
set $original_url "";

# Construct the original URL with the port 8443
set $original_url "https://$host:8443$request_uri";

# URL-encode the state parameter (this is a manual approach for key characters)
set $state_param "";
set $state_param_escape "";

# Example of manually encoding the state parameter
if ($original_url ~* (.*)) {
    set $state_param $1;
    set $state_param_escape $state_param;
    set $state_param_escape $escape_uri;
}

if ($host != auth.braingeneers.gi.ucsc.edu) {
    set $auth_redirect 1;
}

if ($cookie_oauth2_proxy = "") {
    set $auth_redirect 1;
}

if ($auth_redirect = 1) {
    return 302 $scheme://auth.braingeneers.gi.ucsc.edu:8443/oauth2/start?rd=$original_url;
}
