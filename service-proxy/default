# Global auth configuration
auth_request /oauth2/auth;
error_page 401 = /oauth2/sign_in;

# Auth request configuration
auth_request_set $auth_status $upstream_status;
auth_request_set $auth_user $upstream_http_x_auth_request_user;
auth_request_set $auth_email $upstream_http_x_auth_request_email;

# Proxy headers
proxy_set_header X-User $auth_user;
proxy_set_header X-Email $auth_email;
proxy_set_header X-Auth-Request-Redirect $request_uri;

# Auth endpoint
location = /oauth2/auth {
    internal;
    proxy_pass http://auth.braingeneers.gi.ucsc.edu:4180;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_set_header X-Original-URI $request_uri;
}

# Sign-in endpoint
location = /oauth2/sign_in {
    proxy_pass http://auth.braingeneers.gi.ucsc.edu:4180;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Scheme $scheme;
}