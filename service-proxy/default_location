auth_request /oauth2/auth;
auth_request_set $auth_status $upstream_status;

# Only redirect if auth is required and auth request returns 401
error_page 401 = @error401;

location @error401 {
    if ($auth_required = 1) {
        return 302 $scheme://auth.braingeneers.gi.ucsc.edu:8443/oauth2/start?rd=$request_uri;
    }
    return 401;
}

# pass information via X-User and X-Email headers
auth_request_set $user   $upstream_http_x_auth_request_user;
auth_request_set $email  $upstream_http_x_auth_request_email;
proxy_set_header X-User  $user;
proxy_set_header X-Email $email;

# if you enabled --pass-access-token, this will pass the token to the backend
auth_request_set $token  $upstream_http_x_auth_request_access_token;
proxy_set_header X-Access-Token $token;

# preserve the original host
proxy_set_header Host $http_host;